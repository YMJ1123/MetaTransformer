#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

#### Simplified script to generate training reads - no file splitting ###

readonly ART_TOOL_PATH="../../bin/art_illumina"
readonly INVOKE_ART_PATH="./invoke_art.py"
readonly SEQ_SHUF_TOOL_PATH="../../bin/seq-shuf"

# Sequencing system parameters
readonly READ_LENGTH=100
readonly SEQ_SYS="HS25"
readonly MEAN_FRAGMENT_LENGTH=400
readonly FRAGMENT_DEVIATION=50

fasta_in_path=
fasta_out_path=
coverage=1

while getopts "i:c:o:n:" OPTION
do
    case ${OPTION} in
        i)
            fasta_in_path=${OPTARG}
            ;;
        c)
            coverage=${OPTARG}
            ;;
        o)
            fasta_out_path=${OPTARG}
            ;;
        n)  
            echo "Note: -n parameter ignored in simple version"
            ;;
    esac
done

# Create output dir
mkdir -p ${fasta_out_path}
tmp_path=${fasta_out_path}/tmp
mkdir -p ${tmp_path}

echo "Generating reads with ART tool (simple version)."
python3 ${INVOKE_ART_PATH} \
    -i ${fasta_in_path} \
    -l ${READ_LENGTH} \
    -s ${SEQ_SYS} \
    -r -1 \
    -m ${MEAN_FRAGMENT_LENGTH} \
    -d ${FRAGMENT_DEVIATION} \
    -c ${coverage} \
    -t ${ART_TOOL_PATH} \
    -o ${tmp_path}

echo "Checking ART output files..."
if ls ${tmp_path}/reads*.fq 1> /dev/null 2>&1; then
    echo "ART generated FASTQ files successfully"
    ls -la ${tmp_path}/reads*.fq | head -5
else
    echo "Error: No FASTQ files generated by ART!"
    exit 1
fi

# Simple merge - no splitting
echo "Merging FASTQ files..."
cat ${tmp_path}/reads*.fq > ${tmp_path}/all_reads.fq

echo "Validating merged FASTQ file..."
if [ ! -s "${tmp_path}/all_reads.fq" ]; then
    echo "Error: Merged FASTQ file is empty!"
    exit 1
fi

# Check first few lines
echo "First 8 lines of merged FASTQ:"
head -8 ${tmp_path}/all_reads.fq

# Simple FASTQ to FASTA conversion using awk (no multiprocessing)
echo "Converting FASTQ to FASTA..."
awk 'NR%4==1{print ">"substr($0,2)} NR%4==2{print}' ${tmp_path}/all_reads.fq > ${tmp_path}/all_reads.fa

echo "Validating FASTA conversion..."
if [ ! -s "${tmp_path}/all_reads.fa" ]; then
    echo "Error: FASTA conversion failed!"
    exit 1
fi

echo "First 10 lines of FASTA:"
head -10 ${tmp_path}/all_reads.fa

# Shuffle reads
echo "Shuffling reads..."
cat ${tmp_path}/all_reads.fa | seq-shuf > ${fasta_out_path}/reads.fa

# Compress
echo "Compressing output..."
gzip ${fasta_out_path}/reads.fa

echo "Cleaning up temporary files..."
rm -r ${tmp_path}

echo "Simple read generation completed successfully!"
echo "Output: ${fasta_out_path}/reads.fa.gz"

exit 0 